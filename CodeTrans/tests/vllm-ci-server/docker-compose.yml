# Copyright (C) 2025 Intel Corporation
# SPDX-License-Identifier: Apache-2.0

services:
  vllm:
    image: opea/vllm
    container_name: vllm-server-ci-test
    privileged: true
    ports:
      - "8001:8000"  # Map to 8001 to avoid conflict with LiteLLM
    environment:
      - VLLM_CPU_KVCACHE_SPACE=2
      - VLLM_CPU_OMP_THREADS_BIND=0-3
      - HUGGING_FACE_HUB_TOKEN=${HUGGING_FACE_HUB_TOKEN:-hf_ke}
      - OMP_NUM_THREADS=4
    command: >
      --model=HuggingFaceTB/SmolLM-135M-Instruct
      --dtype=bfloat16
      --device=cpu
      --max-model-len=1024
    deploy:
      resources:
        limits:
          memory: 4g
        reservations:
          memory: 2g
    shm_size: '4gb'
    networks:
      - llm-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  litellm:
    image: ghcr.io/berriai/litellm:main-latest
    container_name: litellm-proxy
    ports:
      - "43127:4000"  # LiteLLM proxy external:internal
    environment:
      - LITELLM_MASTER_KEY=${LITELLM_MASTER_KEY:-sk-1234}
      - STORE_MODEL_IN_DB=false
      - LITELLM_MODE=PRODUCTION
      - LITELLM_LOG=INFO
    volumes:
      - ./litellm_config.yaml:/app/config.yaml
    command: --config /app/config.yaml
    depends_on:
      vllm:
        condition: service_healthy
    networks:
      - llm-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

networks:
  llm-network:
    driver: bridge
